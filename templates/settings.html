<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>iZwi - Mobile Menu</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&amp;family=Poppins:wght@500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#19b3a1",
                        "background-light": "#f6f8f8",
                        "background-dark": "#11211f",
                        "text-light": "#11211f",
                        "text-dark": "#f6f8f8",
                        "subtext-light": "#6b7280",
                        "subtext-dark": "#9ca3af",
                        "border-light": "#e5e7eb",
                        "border-dark": "#374151"
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"],
                        "body": ["Poppins", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "0.75rem",
                        "xl": "1rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
<style>
    body {
      min-height: max(884px, 100dvh);
    }
  </style>
  </head>
<body class="bg-background-light dark:bg-background-dark font-display text-text-light dark:text-text-dark">
<div class="min-h-screen">
<header class="flex items-center p-4">
<a href="{{ url_for('dashboard') }}" class="p-2 rounded-full hover:bg-primary/10">
<span class="material-symbols-outlined">arrow_back</span>
</a>
<div class="flex-1 text-center">
<h1 class="font-body font-bold text-lg">Settings</h1>
{% if current_user.role == 'Admin' %}
<div class="flex items-center justify-center gap-2 mt-1">
<span class="bg-primary text-white text-xs px-2 py-1 rounded-full font-medium">ADMIN</span>
<span class="text-xs text-subtext-light dark:text-subtext-dark">{{ community[1] }}</span>
</div>
{% else %}
<span class="text-xs text-subtext-light dark:text-subtext-dark">{{ community[1] }} • Member</span>
{% endif %}
</div>
<div class="w-10"></div>
</header>
<main class="px-4 pb-8 space-y-8">
{% if current_user.role == 'Admin' %}
<section class="bg-gradient-to-r from-primary/10 to-primary/20 rounded-lg p-4 border border-primary/30">
<h2 class="font-body font-semibold text-base mb-3 flex items-center gap-2">
<span class="material-symbols-outlined text-primary">admin_panel_settings</span>
Community Management
</h2>
<div class="space-y-3">
<div class="bg-white dark:bg-background-dark/50 rounded-lg p-3 flex items-center justify-between">
<div>
<p class="font-semibold text-sm">Community Name</p>
<p class="text-xs text-subtext-light dark:text-subtext-dark">{{ community[1] }}</p>
</div>
<button onclick="editCommunityName()" class="bg-primary text-white text-xs px-3 py-2 rounded-full hover:opacity-90">
Edit
</button>
</div>
<div class="bg-white dark:bg-background-dark/50 rounded-lg p-3 flex items-center justify-between">
<div>
<p class="font-semibold text-sm">Community Boundary</p>
<p class="text-xs text-subtext-light dark:text-subtext-dark">Define the area covered by your community</p>
</div>
<button onclick="editBoundary()" class="bg-primary text-white text-xs px-3 py-2 rounded-full hover:opacity-90">
Edit Boundary
</button>
</div>
</div>
</section>
{% endif %}
<section>
<h2 class="font-body font-semibold text-base mb-2">Invite Link</h2>
<div class="bg-white dark:bg-background-dark/50 rounded-lg p-4 flex items-center justify-between shadow-sm border border-border-light dark:border-border-dark">
<p class="truncate text-sm mr-4">{{ request.host_url }}join/{{ community[3] }}</p>
<button class="bg-primary text-white font-body font-medium text-sm px-4 py-2 rounded-full hover:opacity-90 transition-opacity">
                        Copy Link
                    </button>
</div>
</section>
<section>
<h2 class="font-body font-semibold text-base mb-3">Members</h2>
<div class="space-y-3">
{% for member in members %}
<div class="bg-white dark:bg-background-dark/50 rounded-lg p-3 flex items-center justify-between shadow-sm border border-border-light dark:border-border-dark">
<div class="flex items-center gap-4">
<div class="w-12 h-12 rounded-full bg-primary/20 flex items-center justify-center">
<span class="text-primary font-semibold">{{ member[3][:1] if member[3] else member[1][:1] }}</span>
</div>
<div>
<p class="font-semibold">{{ member[3] if member[3] else member[1] }}</p>
<p class="text-sm text-subtext-light dark:text-subtext-dark">{{ member[6] }}</p>
</div>
</div>
{% if member[6] != 'Admin' and current_user.role == 'Admin' %}
<a href="{{ url_for('remove_member', member_id=member[0]) }}" class="bg-primary/20 dark:bg-primary/30 text-primary font-body font-medium text-sm px-4 py-2 rounded-full hover:bg-primary/30 dark:hover:bg-primary/40 transition">
Remove
</a>
{% endif %}
</div>
{% endfor %}
{% if not members %}
<div class="text-center py-8">
<p class="text-subtext-light dark:text-subtext-dark">No members in this community yet.</p>
</div>
{% endif %}
</div>
</section>
<section>
<h2 class="font-body font-semibold text-base mb-3">Subscription</h2>
<div class="bg-white dark:bg-background-dark/50 rounded-lg p-4 flex items-center justify-between shadow-sm border border-border-light dark:border-border-dark">
<div>
<p class="font-semibold">Current Plan</p>
<p class="text-sm text-subtext-light dark:text-subtext-dark">{{ community[4] }}</p>
</div>
<button class="bg-primary text-white font-body font-medium text-sm px-4 py-2 rounded-full hover:opacity-90 transition-opacity">
                        Upgrade Plan
                    </button>
</div>
</section>
<section>
<h2 class="font-body font-semibold text-base mb-3">Account</h2>
<div class="bg-white dark:bg-background-dark/50 rounded-lg p-4 shadow-sm border border-border-light dark:border-border-dark">
<a href="{{ url_for('logout') }}" class="w-full text-left font-semibold text-red-500 block">Logout</a>
</div>
</section>
</main>

<footer class="bg-background dark:bg-background-dark/50 py-4">
<div class="container mx-auto text-center text-xs text-text-secondary dark:text-gray-400">
<div class="flex flex-wrap justify-center gap-3 mb-1">
<a href="{{ url_for('privacy_policy') }}" class="hover:text-primary">Privacy Policy</a>
<span>•</span>
<a href="{{ url_for('terms_of_service') }}" class="hover:text-primary">Terms of Service</a>
</div>
© 2024 iZwi. All rights reserved.
</div>
</footer>
</div>

<!-- Boundary Editing Modal -->
<div id="boundaryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
<div class="bg-white dark:bg-background-dark rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden">
<div class="p-4 border-b border-border-light dark:border-border-dark flex items-center justify-between">
<h3 class="font-body font-semibold text-lg">Edit Community Boundary</h3>
<button onclick="closeBoundaryModal()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
<span class="material-symbols-outlined">close</span>
</button>
</div>
<div class="p-4">
<div class="mb-4 space-y-3">
<div class="flex gap-2">
<input id="addressSearch" type="text" placeholder="Search for address, city, or landmark..." 
       class="flex-1 px-3 py-2 border border-border-light dark:border-border-dark rounded-lg focus:ring-primary focus:border-primary text-sm">
<button onclick="searchAddress()" class="px-4 py-2 bg-primary text-white rounded-lg hover:opacity-90 text-sm font-medium">
Search
</button>
</div>
<div class="flex gap-2">
<button onclick="useMyLocation()" class="flex items-center gap-2 px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 text-sm">
<span class="material-symbols-outlined text-sm">my_location</span>
Use My Location
</button>
<button onclick="goToCommunityCenter()" class="flex items-center gap-2 px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 text-sm">
<span class="material-symbols-outlined text-sm">home</span>
Community Center
</button>
</div>
</div>
<div id="boundaryMap" style="height: 400px; width: 100%;"></div>
<div class="mt-4 text-sm text-subtext-light dark:text-subtext-dark">
<p class="mb-2">Use the drawing tools to define your community boundary:</p>
<ul class="list-disc list-inside space-y-1">
<li>Click the polygon tool to draw a custom shape</li>
<li>Click the circle tool to draw a circular boundary</li>
<li>Click the rectangle tool to draw a rectangular boundary</li>
</ul>
</div>
<div class="mt-4 flex gap-3 justify-end">
<button onclick="closeBoundaryModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium">
Cancel
</button>
<button onclick="saveBoundary()" class="px-4 py-2 bg-primary text-white rounded-lg hover:opacity-90 font-medium">
Save Boundary
</button>
</div>
</div>
</div>
</div>

<!-- Community Name Edit Modal -->
<div id="nameModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
<div class="bg-white dark:bg-background-dark rounded-lg max-w-md w-full">
<div class="p-4 border-b border-border-light dark:border-border-dark flex items-center justify-between">
<h3 class="font-body font-semibold text-lg">Edit Community Name</h3>
<button onclick="closeNameModal()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
<span class="material-symbols-outlined">close</span>
</button>
</div>
<div class="p-4">
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
<label class="block text-sm font-medium mb-2">Community Name</label>
<input id="communityNameInput" type="text" value="{{ community[1] }}" 
       class="w-full px-3 py-2 border border-border-light dark:border-border-dark rounded-lg focus:ring-primary focus:border-primary">
<div class="mt-4 flex gap-3 justify-end">
<button onclick="closeNameModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium">
Cancel
</button>
<button onclick="saveCommunityName()" class="px-4 py-2 bg-primary text-white rounded-lg hover:opacity-90 font-medium">
Save Name
</button>
</div>
</div>
</div>
</div>

<script>
let boundaryMap = null;
let drawnItems = null;
let currentBoundary = null;

function editCommunityName() {
    document.getElementById('nameModal').classList.remove('hidden');
}

function closeNameModal() {
    document.getElementById('nameModal').classList.add('hidden');
}

function editBoundary() {
    document.getElementById('boundaryModal').classList.remove('hidden');
    setTimeout(initBoundaryMap, 100); // Allow modal to fully open before initializing map
}

function closeBoundaryModal() {
    document.getElementById('boundaryModal').classList.add('hidden');
    if (boundaryMap) {
        boundaryMap.remove();
        boundaryMap = null;
    }
}

function initBoundaryMap() {
    // Initialize map with default location
    boundaryMap = L.map('boundaryMap').setView([-26.2041, 28.0473], 13);
    
    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(boundaryMap);
    
    // Try to use user's location first, then existing boundary, then default
    getUserLocationAndCenter();
    
    // Create feature group for drawn items
    drawnItems = new L.FeatureGroup();
    boundaryMap.addLayer(drawnItems);
    
    // Add drawing controls
    var drawControl = new L.Control.Draw({
        edit: {
            featureGroup: drawnItems,
            remove: true
        },
        draw: {
            polygon: true,
            circle: true,
            rectangle: true,
            marker: false,
            circlemarker: false,
            polyline: false
        }
    });
    boundaryMap.addControl(drawControl);
    
    // Load existing boundary if available
    {% if community[5] %}
    try {
        var existingBoundary = {{ community[5]|safe }};
        if (existingBoundary) {
            var geoJsonData = JSON.parse(existingBoundary);
            var layer = L.geoJSON(geoJsonData);
            drawnItems.addLayer(layer.getLayers()[0]);
            boundaryMap.fitBounds(drawnItems.getBounds(), { padding: [20, 20] });
        }
    } catch (e) {
        console.log('Error loading existing boundary:', e);
    }
    {% endif %}
    
    // Handle drawing events
    boundaryMap.on(L.Draw.Event.CREATED, function (event) {
        // Clear previous drawings
        drawnItems.clearLayers();
        // Add new drawing
        drawnItems.addLayer(event.layer);
        currentBoundary = event.layer.toGeoJSON();
    });
    
    boundaryMap.on(L.Draw.Event.EDITED, function (event) {
        var layers = event.layers;
        layers.eachLayer(function (layer) {
            currentBoundary = layer.toGeoJSON();
        });
    });
    
    boundaryMap.on(L.Draw.Event.DELETED, function (event) {
        currentBoundary = null;
    });
}

function saveCommunityName() {
    const name = document.getElementById('communityNameInput').value.trim();
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    
    if (!name) {
        alert('Community name is required');
        return;
    }
    
    fetch('/update-community-name', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            name: name
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Refresh to show updated name
        } else {
            alert(data.message || 'Error updating community name');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating community name');
    });
}

function saveBoundary() {
    if (!currentBoundary && drawnItems.getLayers().length === 0) {
        alert('Please draw a boundary first');
        return;
    }
    
    // Get the current boundary or the first layer if current boundary is not set
    let boundaryData = currentBoundary;
    if (!boundaryData && drawnItems.getLayers().length > 0) {
        boundaryData = drawnItems.getLayers()[0].toGeoJSON();
    }
    
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    
    fetch('/update-community-boundary', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            boundary_data: JSON.stringify(boundaryData)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeBoundaryModal();
            alert('Community boundary updated successfully!');
        } else {
            alert(data.message || 'Error updating boundary');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating boundary');
    });
}

function getUserLocationAndCenter() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                boundaryMap.setView([lat, lng], 15);
                
                // Add a temporary marker to show user's location
                L.marker([lat, lng]).addTo(boundaryMap)
                    .bindPopup('Your current location')
                    .openPopup();
            },
            function(error) {
                console.log('Geolocation error:', error);
                // If geolocation fails, try to center on existing boundary
                centerOnExistingBoundary();
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 300000 }
        );
    } else {
        // If geolocation not available, center on existing boundary
        centerOnExistingBoundary();
    }
}

function centerOnExistingBoundary() {
    {% if community[5] %}
    try {
        var existingBoundary = {{ community[5]|safe }};
        if (existingBoundary) {
            var geoJsonData = JSON.parse(existingBoundary);
            var layer = L.geoJSON(geoJsonData);
            boundaryMap.fitBounds(layer.getBounds(), { padding: [20, 20] });
            return;
        }
    } catch (e) {
        console.log('Error loading existing boundary for centering:', e);
    }
    {% endif %}
    // Default fallback - keep Johannesburg coordinates
}

function useMyLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                boundaryMap.setView([lat, lng], 16);
                
                // Remove any existing location markers
                boundaryMap.eachLayer(function(layer) {
                    if (layer instanceof L.Marker && layer.getPopup() && 
                        layer.getPopup().getContent() === 'Your current location') {
                        boundaryMap.removeLayer(layer);
                    }
                });
                
                // Add new location marker
                L.marker([lat, lng]).addTo(boundaryMap)
                    .bindPopup('Your current location')
                    .openPopup();
            },
            function(error) {
                alert('Unable to get your location. Please check your browser permissions.');
            },
            { enableHighAccuracy: true, timeout: 5000 }
        );
    } else {
        alert('Geolocation is not supported by your browser.');
    }
}

function goToCommunityCenter() {
    {% if community[5] %}
    try {
        var existingBoundary = {{ community[5]|safe }};
        if (existingBoundary) {
            var geoJsonData = JSON.parse(existingBoundary);
            var layer = L.geoJSON(geoJsonData);
            boundaryMap.fitBounds(layer.getBounds(), { padding: [20, 20] });
            return;
        }
    } catch (e) {
        console.log('Error loading community boundary:', e);
    }
    {% endif %}
    alert('No community boundary set yet. Draw a boundary first to use this feature.');
}

function searchAddress() {
    const query = document.getElementById('addressSearch').value.trim();
    if (!query) {
        alert('Please enter an address or location to search for.');
        return;
    }
    
    // Use OpenStreetMap Nominatim for geocoding (free, no API key needed)
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&countrycodes=za`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data && data.length > 0) {
                const result = data[0];
                const lat = parseFloat(result.lat);
                const lng = parseFloat(result.lon);
                
                boundaryMap.setView([lat, lng], 15);
                
                // Add a marker for the searched location
                L.marker([lat, lng]).addTo(boundaryMap)
                    .bindPopup(`Found: ${result.display_name}`)
                    .openPopup();
                    
                // Clear the search box
                document.getElementById('addressSearch').value = '';
            } else {
                alert('Location not found. Please try a different search term.');
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            alert('Error searching for location. Please try again.');
        });
}

// Allow Enter key to trigger search
document.addEventListener('DOMContentLoaded', function() {
    const addressInput = document.getElementById('addressSearch');
    if (addressInput) {
        addressInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchAddress();
            }
        });
    }
});
</script>

</body></html>