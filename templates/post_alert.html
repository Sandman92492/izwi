<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>iZwi - Post Alert</title>
<script src="https://cdn.tailwindcss.com?plugins=forms"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#19b3a1",
            "background-light": "#f6f8f8",
            "background-dark": "#11211f",
          },
          fontFamily: {
            "display": ["Inter"]
          },
          borderRadius: {
            "DEFAULT": "0.25rem",
            "lg": "0.5rem",
            "xl": "0.75rem",
            "full": "9999px"
          },
        },
      },
    }
  </script>
<style>
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
  </style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark min-h-screen">
<div class="min-h-screen flex flex-col">
<header class="flex items-center justify-between p-4 border-b bg-background-light dark:bg-background-dark">
<a href="{{ url_for('dashboard') }}" class="p-2 rounded-full hover:bg-gray-100">
<span class="material-symbols-outlined">arrow_back</span>
</a>
<h1 class="text-xl font-bold text-gray-900 dark:text-white">Post Alert</h1>
<div class="w-10"></div>
</header>

<main class="flex-1 overflow-y-auto">

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="p-4 space-y-3 max-w-md mx-auto">
      {% for category, message in messages %}
        <div class="alert-message p-4 rounded-lg border-l-4 {% if category == 'success' %}bg-green-50 border-green-400 text-green-700 dark:bg-green-900/20 dark:border-green-500 dark:text-green-300{% elif category == 'error' %}bg-red-50 border-red-400 text-red-700 dark:bg-red-900/20 dark:border-red-500 dark:text-red-300{% else %}bg-blue-50 border-blue-400 text-blue-700 dark:bg-blue-900/20 dark:border-blue-500 dark:text-blue-300{% endif %}" role="alert">
          <div class="flex items-center">
            <span class="mr-2">
              {% if category == 'success' %}‚úÖ{% elif category == 'error' %}‚ùå{% else %}‚ÑπÔ∏è{% endif %}
            </span>
            <span class="text-sm font-medium">{{ message }}</span>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<form method="POST" action="{{ url_for('post_alert') }}" class="p-4 space-y-6 max-w-md mx-auto">
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
<div>
<h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3">Category</h2>
<input type="hidden" name="category" id="selected_category" required>
<div class="grid grid-cols-2 gap-3">
<button type="button" onclick="selectCategory(event, 'Emergency')" class="category-btn flex items-center gap-3 p-4 rounded-lg bg-white border-2 border-gray-200 hover:shadow-md transition-all duration-200 focus:ring-2 focus:ring-red-500 focus:outline-none">
<span class="text-2xl">üö®</span>
<span class="font-semibold text-gray-900">Emergency</span>
</button>
<button type="button" onclick="selectCategory(event, 'Fire')" class="category-btn flex items-center gap-3 p-4 rounded-lg bg-white border-2 border-gray-200 hover:shadow-md transition-all duration-200 focus:ring-2 focus:ring-orange-500 focus:outline-none">
<span class="text-2xl">üî•</span>
<span class="font-semibold text-gray-900">Fire</span>
</button>
<button type="button" onclick="selectCategory(event, 'Traffic')" class="category-btn flex items-center gap-3 p-4 rounded-lg bg-white border-2 border-gray-200 hover:shadow-md transition-all duration-200 focus:ring-2 focus:ring-blue-500 focus:outline-none">
<span class="text-2xl">üöó</span>
<span class="font-semibold text-gray-900">Traffic</span>
</button>
<button type="button" onclick="selectCategory(event, 'Weather')" class="category-btn flex items-center gap-3 p-4 rounded-lg bg-white border-2 border-gray-200 hover:shadow-md transition-all duration-200 focus:ring-2 focus:ring-purple-500 focus:outline-none">
<span class="text-2xl">‚õàÔ∏è</span>
<span class="font-semibold text-gray-900">Weather</span>
</button>
<button type="button" onclick="selectCategory(event, 'Community')" class="category-btn flex items-center gap-3 p-4 rounded-lg bg-white border-2 border-gray-200 hover:shadow-md transition-all duration-200 focus:ring-2 focus:ring-green-500 focus:outline-none">
<span class="text-2xl">üèòÔ∏è</span>
<span class="font-semibold text-gray-900">Community</span>
</button>
<button type="button" onclick="selectCategory(event, 'Other')" class="category-btn flex items-center gap-3 p-4 rounded-lg bg-white border-2 border-gray-200 hover:shadow-md transition-all duration-200 focus:ring-2 focus:ring-gray-500 focus:outline-none">
<span class="text-2xl">‚ùó</span>
<span class="font-semibold text-gray-900">Other</span>
</button>
</div>
</div>

<div>
<h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3">Describe what's happening...</h2>
<textarea name="description" class="w-full h-28 p-3 rounded-lg bg-white dark:bg-background-dark border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-primary focus:border-primary focus:outline-none resize-none" placeholder="Add details here..." required></textarea>
</div>

<div>
<h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3">Location</h2>
<div class="mb-3 flex gap-2">
<button type="button" onclick="requestCurrentLocation()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
<span class="text-sm">üìç</span>
<span class="text-sm font-medium">Use My Location</span>
</button>
<div id="location-status" class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400"></div>
</div>
<div class="relative h-64 w-full rounded-xl overflow-hidden">
<div id="location-map" class="w-full h-full"></div>
<div class="absolute top-3 left-3 bg-white/90 dark:bg-black/70 p-2 rounded-lg shadow-lg text-xs">
<span class="text-gray-800 dark:text-gray-200">Click "Use My Location" or click on the map to set location</span>
</div>
</div>
<input type="hidden" name="latitude" id="latitude">
<input type="hidden" name="longitude" id="longitude">
</div>

<button type="submit" id="post-alert-btn" class="w-full bg-primary text-white font-bold py-4 rounded-xl hover:bg-opacity-90 transition-colors duration-200">
<span class="btn-text">Post Alert</span>
<span class="btn-loading hidden">Posting...</span>
</button>
</form>
</main>
</div>

<script>
// Initialize location map
var locationMap = L.map('location-map').setView([-26.2041, 28.0473], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
}).addTo(locationMap);

var selectedMarker = null;
var selectedCategory = null;

// Handle map clicks for location selection
locationMap.on('click', function(e) {
    var lat = e.latlng.lat;
    var lng = e.latlng.lng;
    
    // Remove existing marker
    if (selectedMarker) {
        locationMap.removeLayer(selectedMarker);
    }
    
    // Add new marker
    selectedMarker = L.marker([lat, lng]).addTo(locationMap);
    
    // Update form fields
    document.getElementById('latitude').value = lat;
    document.getElementById('longitude').value = lng;
});

// Location detection functions
function requestCurrentLocation() {
    if (!navigator.geolocation) {
        showLocationStatus('Location services not supported by your browser', 'error');
        return;
    }

    showLocationStatus('Getting your location...', 'loading');

    navigator.geolocation.getCurrentPosition(
        function(position) {
            var lat = position.coords.latitude;
            var lng = position.coords.longitude;
            
            // Update map view
            locationMap.setView([lat, lng], 15);
            
            // Remove existing marker
            if (selectedMarker) {
                locationMap.removeLayer(selectedMarker);
            }
            
            // Add marker at current location
            selectedMarker = L.marker([lat, lng]).addTo(locationMap);
            selectedMarker.bindPopup('<div class="text-center p-2"><strong>Your Current Location</strong></div>');
            
            // Update form fields
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
            
            showLocationStatus('Location set successfully', 'success');
        },
        function(error) {
            var message = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Location access denied. Please manually click on the map to set location.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Location unavailable. Please manually click on the map to set location.';
                    break;
                case error.TIMEOUT:
                    message = 'Location request timed out. Please try again or manually click on the map.';
                    break;
                default:
                    message = 'Error getting location. Please manually click on the map to set location.';
                    break;
            }
            showLocationStatus(message, 'error');
            console.log('Geolocation error:', error);
        },
        {
            timeout: 10000, // 10 second timeout
            enableHighAccuracy: true,
            maximumAge: 300000 // 5 minutes cache
        }
    );
}

function showLocationStatus(message, type) {
    const statusDiv = document.getElementById('location-status');
    
    let icon = '';
    let className = '';
    
    switch(type) {
        case 'loading':
            icon = '<div class="animate-spin w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full"></div>';
            className = 'text-blue-600';
            break;
        case 'success':
            icon = '‚úÖ';
            className = 'text-green-600';
            break;
        case 'error':
            icon = '‚ö†Ô∏è';
            className = 'text-yellow-600';
            break;
        default:
            icon = '‚ÑπÔ∏è';
            className = 'text-gray-600';
    }
    
    statusDiv.innerHTML = `<span>${icon}</span><span class="${className}">${message}</span>`;
    
    // Auto-hide success/error messages after 5 seconds
    if (type === 'success' || type === 'error') {
        setTimeout(() => {
            statusDiv.innerHTML = '';
        }, 5000);
    }
}

// Category selection
function selectCategory(event, category) {
    // Get category colors
    const colors = {
        'Emergency': '#DC2626',
        'Fire': '#EA580C', 
        'Traffic': '#2563EB',
        'Weather': '#7C3AED',
        'Community': '#059669',
        'Other': '#6B7280'
    };
    
    // Remove previous selection
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.style.backgroundColor = 'white';
        btn.style.borderColor = '#E5E7EB';
        btn.style.color = '#111827';
    });
    
    // Highlight selected category
    const selectedBtn = event.target.closest('.category-btn');
    selectedBtn.style.backgroundColor = colors[category];
    selectedBtn.style.borderColor = colors[category];
    selectedBtn.style.color = 'white';
    
    // Update form field
    document.getElementById('selected_category').value = category;
    selectedCategory = category;
}

// Add loading state functionality
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const submitBtn = document.getElementById('post-alert-btn');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');
    
    form.addEventListener('submit', function(e) {
        // Check if category is selected
        const selectedCategory = document.getElementById('selected_category').value;
        if (!selectedCategory) {
            e.preventDefault();
            alert('Please select a category for your alert.');
            return;
        }
        
        // Check if location is set
        const latitude = document.getElementById('latitude').value;
        const longitude = document.getElementById('longitude').value;
        
        if (!latitude || !longitude || (latitude === '0' && longitude === '0')) {
            e.preventDefault();
            alert('Please set your location by clicking "Use My Location" or clicking on the map.');
            showLocationStatus('Location required - please click "Use My Location" or click on the map', 'error');
            return;
        }
        
        // Disable button and show loading state
        submitBtn.disabled = true;
        submitBtn.classList.add('opacity-75', 'cursor-not-allowed');
        btnText.classList.add('hidden');
        btnLoading.classList.remove('hidden');
    });
    
    // Auto-hide flash messages after 5 seconds
    const alertMessages = document.querySelectorAll('.alert-message');
    alertMessages.forEach(function(message) {
        setTimeout(function() {
            message.style.transition = 'opacity 0.5s ease-out';
            message.style.opacity = '0';
            setTimeout(function() {
                message.remove();
            }, 500);
        }, 5000);
    });
});
</script>

<footer class="bg-background dark:bg-background-dark/50 py-4 mt-8">
<div class="container mx-auto text-center text-xs text-text-secondary dark:text-gray-400">
<div class="flex flex-wrap justify-center gap-3 mb-1">
<a href="{{ url_for('privacy_policy') }}" class="hover:text-primary">Privacy Policy</a>
<span>‚Ä¢</span>
<a href="{{ url_for('terms_of_service') }}" class="hover:text-primary">Terms of Service</a>
</div>
¬© 2024 iZwi. All rights reserved.
</div>
</footer>

</body></html>