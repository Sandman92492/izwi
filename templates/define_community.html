<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<title>iZwi - Define Community</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#2A9D8F",
              "background-light": "#F8F9FA",
              "background-dark": "#1A202C",
              "content-light": "#111827",
              "content-dark": "#F8F9FA",
              "subtle-light": "#E5E7EB",
              "subtle-dark": "#4A5568",
              "placeholder-light": "#9CA3AF",
              "placeholder-dark": "#718096",
            },
            fontFamily: {
              display: ["Inter", "sans-serif"],
            },
            borderRadius: {
              DEFAULT: "0.5rem",
              lg: "0.75rem",
              full: "9999px",
            },
          },
        },
      };
    </script>
<style>
      .material-symbols-outlined {
        font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
      }
    </style>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<style>
    body {
      min-height: max(884px, 100dvh);
    }
  </style>
  </head>
<body class="bg-background-light dark:bg-background-dark font-display text-content-light dark:text-content-dark">
<div class="flex h-screen flex-col">
<header class="flex items-center justify-between p-4">
<div class="flex items-center gap-2">
<a href="{{ url_for('index') }}" class="rounded-full p-2 hover:bg-subtle-light dark:hover:bg-subtle-dark" title="Go to Home">
<svg class="text-content-light dark:text-content-dark" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M19 12H5"></path>
<path d="M12 19l-7-7 7-7"></path>
</svg>
</a>
</div>
<h1 class="text-lg font-bold">Define Your Community</h1>
<div class="flex items-center gap-2">
<a href="{{ url_for('logout') }}" class="text-sm px-3 py-2 rounded-lg bg-subtle-light dark:bg-subtle-dark hover:bg-primary hover:text-white transition-colors">
Sign in as different user
</a>
</div>
</header>
<main class="flex flex-1 flex-col gap-4 p-4">
<form method="POST" class="flex flex-1 flex-col gap-4">
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
<div class="flex flex-col">
<label class="sr-only" for="community-name">Community Name</label>
<input class="h-14 w-full rounded-lg border-none bg-subtle-light px-4 text-content-light placeholder-placeholder-light focus:ring-2 focus:ring-primary dark:bg-subtle-dark dark:text-content-dark dark:placeholder-placeholder-dark" id="community-name" name="community_name" placeholder="Community Name" type="text" required/>
<input type="hidden" name="boundary_data" id="boundary_data">
</div>
<div class="relative flex-1 rounded-lg bg-subtle-light dark:bg-subtle-dark">
<div id="community-map" class="w-full h-full rounded-lg"></div>
<div class="absolute top-3 left-3 bg-background-light/90 dark:bg-background-dark/90 p-3 rounded-lg shadow-lg text-sm z-10">
<p class="text-content-light dark:text-content-dark">
              Use the tools below to draw your community boundaries on the map.
            </p>
</div>
</div>
</main>
<footer class="p-4">
<button type="submit" class="h-14 w-full rounded-lg bg-primary text-white font-bold hover:bg-primary/90">
          Create Community
        </button>
</form>
</footer>
</div>

<script>
// Initialize the community boundary map
var communityMap = L.map('community-map').setView([-26.2041, 28.0473], 13);

// Add tile layer
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
}).addTo(communityMap);

// Initialize the FeatureGroup to store editable layers
var drawnItems = new L.FeatureGroup();
communityMap.addLayer(drawnItems);

// Initialize the draw control and pass it the FeatureGroup of editable layers
var drawControl = new L.Control.Draw({
    edit: {
        featureGroup: drawnItems
    },
    draw: {
        polygon: {
            allowIntersection: false,
            drawError: {
                color: '#e1e100',
                message: '<strong>Error:</strong> shape edges cannot cross!'
            },
            shapeOptions: {
                color: '#2A9D8F',
                fillOpacity: 0.2
            }
        },
        polyline: false,
        rectangle: {
            shapeOptions: {
                color: '#2A9D8F',
                fillOpacity: 0.2
            }
        },
        circle: {
            shapeOptions: {
                color: '#2A9D8F',
                fillOpacity: 0.2
            }
        },
        marker: false,
        circlemarker: false
    }
});
communityMap.addControl(drawControl);

// Get user's current location for initial map center
if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
        var lat = position.coords.latitude;
        var lng = position.coords.longitude;
        communityMap.setView([lat, lng], 15);
    });
}

// Handle drawing events
communityMap.on(L.Draw.Event.CREATED, function (e) {
    var type = e.layerType,
        layer = e.layer;

    // Clear existing drawings (only allow one boundary)
    drawnItems.clearLayers();
    
    // Add the new boundary
    drawnItems.addLayer(layer);
    
    // Store boundary data
    var boundaryData = layer.toGeoJSON();
    document.getElementById('boundary_data').value = JSON.stringify(boundaryData);
    console.log('Community boundary defined:', boundaryData);
});

communityMap.on(L.Draw.Event.EDITED, function (e) {
    var layers = e.layers;
    layers.eachLayer(function (layer) {
        var boundaryData = layer.toGeoJSON();
        document.getElementById('boundary_data').value = JSON.stringify(boundaryData);
        console.log('Community boundary updated:', boundaryData);
    });
});

communityMap.on(L.Draw.Event.DELETED, function (e) {
    document.getElementById('boundary_data').value = '';
    console.log('Community boundary deleted');
});
</script>

</body></html>