<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>iZwi - Community Alerts</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&amp;family=Poppins:wght@500;600&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
.custom-alert-marker {
    background: transparent !important;
    border: none !important;
    animation: pulse-once 0.8s ease-out;
}

@keyframes pulse-once {
    0% {
        transform: scale(0.8);
        opacity: 0.7;
    }
    50% {
        transform: scale(1.1);
        opacity: 1;
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

.custom-alert-marker:hover {
    transform: scale(1.1);
    transition: transform 0.2s ease;
}
</style>
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#264653",
                        "secondary": "#E9C46A",
                        "background": "#F8F9FA",
                        "text-primary": "#264653",
                        "alert-crime": "#E76F51",
                        "alert-utility": "#F4A261",
                        "alert-event": "#2A9D8F",
                        "text-secondary": "#6C757D"
                    },
                    fontFamily: {
                        "display": ["Poppins", "sans-serif"],
                        "body": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.75rem",
                        "lg": "1rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
<style>
        .font-display { font-family: 'Poppins', sans-serif; }
        .font-body { font-family: 'Inter', sans-serif; }
    </style>
<style>
        body {
            min-height: max(884px, 100dvh);
        }
    </style>
<style>
    body {
      min-height: max(884px, 100dvh);
    }
  </style>
  </head>
<body class="bg-background font-body text-text-primary">
<div class="flex flex-col h-screen">
<header class="flex items-center justify-between p-4 bg-background-light dark:bg-background-dark shadow-sm">
<img alt="iZwi Logo" class="h-8 w-auto" src="https://lh3.googleusercontent.com/aida-public/AB6AXuB_pOQD51q3I4utHDxslkN1ZBiEl-4EUWUU_FQqCvGSavCkVmN-lbf04w7_Qh8qmxlpIxQojb1JpWBbWB1eiNFCNbgo9wGtZYgh8ApxzdC9NzEOlxHQUWlFF8metjKlTZAyDzSD4QMrQxzEdtnsbwKGkDUezK7Ll1FoufX6C2r39f4Mjp59oBfDyVtQB7yHBri-X5_zV2ASI6UP7U117eycls3T2YarZGCWiS_EwxzQMbhIKeFZw-2DLoO3ygX6j-W3d_i-i1TEpoU"/>
<a href="{{ url_for('settings') }}" class="p-2 rounded-full">
<svg class="h-8 w-8 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</a>
</header>
<main class="flex-1 flex flex-col overflow-hidden">
<div class="h-1/2 relative">
<div id="map" class="w-full h-full"></div>
</div>
<div class="h-1/2 flex flex-col bg-white">
<div class="p-4 border-b border-gray-200">
<h2 class="font-display font-bold text-xl text-primary">Recent Alerts</h2>
</div>
<div class="flex-1 overflow-y-auto p-4 space-y-3">
{% for alert in alerts %}
<div class="bg-white rounded-lg border-l-4 shadow-sm hover:shadow-md transition-shadow duration-200" 
     style="border-left-color: {{ get_category_color(alert[3]) }}">
<div class="p-4">
<div class="flex items-center justify-between">
<div class="flex items-center gap-3">
<div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-lg font-bold" 
     style="background-color: {{ get_category_color(alert[3]) }}">
{{ get_category_icon(alert[3]) }}
</div>
<div>
<div class="flex items-center gap-2">
<span class="font-semibold text-gray-900">{{ alert[3] }}</span>
<span class="text-xs px-2 py-1 rounded-full text-gray-600 bg-gray-100">
{{ format_time_ago(alert[7]) }}
</span>
</div>
<p class="text-sm text-gray-600 mt-1">{{ alert[4] }}</p>
</div>
</div>
<div class="flex items-center text-xs text-gray-400">
<span class="material-symbols-outlined text-sm mr-1">person</span>
{{ alert[8] if alert[8] else 'Anonymous' }}
</div>
</div>
</div>
</div>
{% endfor %}
{% if not alerts %}
<div class="text-center py-8">
<div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-100 flex items-center justify-center">
<span class="material-symbols-outlined text-2xl text-gray-400">notifications_off</span>
</div>
<p class="text-gray-500">No recent alerts in your community.</p>
<p class="text-sm text-gray-400 mt-1">Post the first alert to get started!</p>
</div>
{% endif %}
</div>
</div>
</main>
<button onclick="showPostAlert()" class="absolute bottom-6 right-6 bg-secondary text-primary h-16 w-16 rounded-full shadow-lg flex items-center justify-center">
<svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M12 4v16m8-8H4" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
</div>

<script>
// Alert markers data
var alerts = [
    {% for alert in alerts %}
    {
        id: {{ alert[0] }},
        category: "{{ alert[3] }}",
        description: "{{ alert[4] }}",
        lat: {{ alert[5] if alert[5] else -26.2041 }},
        lng: {{ alert[6] if alert[6] else 28.0473 }},
        timestamp: "{{ alert[7] }}"
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

// Calculate map center based on alerts
var mapCenter = [-26.2041, 28.0473]; // Default to Johannesburg
var mapZoom = 13;

if (alerts.length > 0) {
    // Filter alerts with valid coordinates
    var validAlerts = alerts.filter(function(alert) {
        return alert.lat !== -26.2041 || alert.lng !== 28.0473;
    });
    
    if (validAlerts.length > 0) {
        // Calculate average coordinates
        var sumLat = validAlerts.reduce(function(sum, alert) { return sum + alert.lat; }, 0);
        var sumLng = validAlerts.reduce(function(sum, alert) { return sum + alert.lng; }, 0);
        
        mapCenter = [sumLat / validAlerts.length, sumLng / validAlerts.length];
        mapZoom = validAlerts.length === 1 ? 15 : 13; // Zoom closer for single alert
    }
}

// Initialize the map with calculated center
var map = L.map('map').setView(mapCenter, mapZoom);

// Add tile layer
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
}).addTo(map);

// Community boundary variable
var communityBoundary = null;

// Load and display community boundary if available
{% if boundary_data %}
try {
    var boundaryData = {{ boundary_data|tojson }};
    if (boundaryData) {
        var geoJsonData = JSON.parse(boundaryData);
        
        // Add boundary to map with styling
        communityBoundary = L.geoJSON(geoJsonData, {
            style: {
                color: '#264653',
                weight: 3,
                opacity: 0.8,
                fillColor: '#264653',
                fillOpacity: 0.1,
                dashArray: '5, 5'
            }
        }).addTo(map);
        
        // Fit map to boundary if no alerts or if alerts don't provide good bounds
        if (alerts.length === 0) {
            map.fitBounds(communityBoundary.getBounds(), {
                padding: [20, 20]
            });
        }
    }
} catch (e) {
    console.log('Error loading community boundary:', e);
}
{% endif %}

// Add markers for each alert
alerts.forEach(function(alert) {
    var categoryColor = getCategoryColor(alert.category);
    var categoryIcon = getCategoryIcon(alert.category);
    
    var icon = L.divIcon({
        className: 'custom-alert-marker',
        html: '<div class="relative">' +
              '<div class="w-12 h-12 rounded-full flex items-center justify-center text-white text-xl font-bold shadow-lg border-4 border-white" style="background-color: ' + categoryColor + ';">' + 
              categoryIcon + 
              '</div>' +
              '<div class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-8 border-transparent" style="border-top-color: ' + categoryColor + ';"></div>' +
              '</div>',
        iconSize: [48, 56],
        iconAnchor: [24, 48]
    });
    
    var marker = L.marker([alert.lat, alert.lng], {icon: icon}).addTo(map);
    marker.bindPopup('<div class="p-3"><div class="flex items-center gap-2 mb-2"><span class="text-lg">' + categoryIcon + '</span><strong class="text-lg">' + alert.category + '</strong></div>' + 
                     '<p class="text-gray-700">' + alert.description + '</p><small class="text-gray-500">' + alert.timestamp + '</small></div>');
});

// If no valid alerts, try to get user's location
if (alerts.length === 0 || alerts.every(function(alert) { 
    return alert.lat === -26.2041 && alert.lng === 28.0473; 
})) {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            var userLat = position.coords.latitude;
            var userLng = position.coords.longitude;
            map.setView([userLat, userLng], 15);
        });
    }
}

function getCategoryIcon(category) {
    switch(category.toLowerCase()) {
        case 'emergency': return '🚨';
        case 'fire': return '🔥';
        case 'traffic': return '🚗';
        case 'weather': return '⛈️';
        case 'community': return '🏘️';
        default: return '❗';
    }
}

function getCategoryColor(category) {
    switch(category.toLowerCase()) {
        case 'emergency': return '#DC2626'; // Red
        case 'fire': return '#EA580C'; // Orange-red
        case 'traffic': return '#2563EB'; // Blue
        case 'weather': return '#7C3AED'; // Purple
        case 'community': return '#059669'; // Green
        default: return '#6B7280'; // Gray
    }
}

function showPostAlert() {
    window.location.href = '/post-alert';
}
</script>

</body></html>